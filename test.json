{
  "meta": {
    "id": "2024/ssh_otp_automation",
    "title": "SSHのOTP認証を自動突破する",
    "description": "大学のスパコンのSSHで毎回OTP要求されるのが大変だったので認証を自動化した",
    "date": "2024-09-07",
    "tags": ["tech"],
    "publish": true
  },
  "folded": {
    "type": "partial",
    "children": [
      {
        "type": "html",
        "tag": "p",
        "attrs": {},
        "content": {
          "type": "html",
          "content": "筑波大学の<wbr>スーパーコンピューターの<wbr>SSHは<wbr>公開鍵認証に<wbr>加え、<wbr>OTPに<wbr>よる<wbr>認証が<wbr>あるが<wbr>毎回パスワード入力するのが<wbr>本当に<wbr>面倒。"
        },
        "id": "9ecEjOJxR06FPc_RieKEiw"
      },
      {
        "type": "html",
        "tag": "section",
        "attrs": {},
        "content": {
          "type": "partial",
          "children": [
            {
              "type": "keep",
              "custom": {
                "type": "heading",
                "tag": "h2",
                "slug": "認証自動化"
              },
              "id": "tUbGIx1XSvCuDxX5K-Iu9Q",
              "content": { "type": "html", "content": "認証自動化" }
            },
            {
              "type": "html",
              "tag": "p",
              "attrs": {},
              "content": {
                "type": "html",
                "content": "OTPは<wbr>1passwordで<wbr>管理しているので<wbr>otp自体は<wbr>1password cli経由で<wbr>取れる。<wbr>面倒なのは<wbr>sshコネクションでの<wbr>自動化だが、<wbr>これは<code>expect(1)</code>で<wbr>自動化できる。<wbr>スクリプトは<wbr>こんな<wbr>感じ"
              },
              "id": "URpAfS6zSPCscWLcaEbt0w"
            },
            {
              "type": "keep",
              "custom": {
                "type": "codeblock",
                "lines": 10,
                "title": "bash",
                "content": "<span class=\"source shell bash\"><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment begin shell\">#</span></span><span class=\"comment line number-sign shell\">!/usr/bin/expectset timeout 5set cmd [lrange $argv 1 end]set password [lindex $argv 0]eval spawn $cmdexpect &quot;Verification code:&quot;send &quot;$password\\r&quot;;interact</span></span>"
              },
              "id": "JN7rC_ZtTMOmewiSZmGbwA",
              "content": { "type": "html", "content": "" }
            },
            {
              "type": "html",
              "tag": "p",
              "attrs": {},
              "content": {
                "type": "html",
                "content": "使い<wbr>方は<wbr>こう。<wbr>これを<wbr>適当な<wbr>シェルスクリプトに<wbr>して<wbr>おくと<wbr>コマンド一発で<wbr>入れて<wbr>便利。"
              },
              "id": "aNXwCk3YQGiVcBvO3V-0Tg"
            },
            {
              "type": "keep",
              "custom": {
                "type": "codeblock",
                "lines": 1,
                "title": "bash",
                "content": "<span class=\"source shell bash\"><span class=\"meta function-call shell\"><span class=\"variable function shell\">ssh-with-otp</span></span><span class=\"meta function-call arguments shell\"> <span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\">&quot;</span><span class=\"meta group expansion command parens shell\"><span class=\"punctuation definition variable shell\">$</span><span class=\"punctuation section parens begin shell\">(</span><span class=\"meta function-call shell\"><span class=\"variable function shell\">op</span></span><span class=\"meta function-call arguments shell\"> read <span class=\"string quoted double shell\"><span class=\"punctuation definition string begin shell\">&quot;</span>op://Personal/supacon/otp?attribute=otp<span class=\"punctuation definition string end shell\">&quot;</span></span></span><span class=\"punctuation section parens end shell\">)</span></span><span class=\"punctuation definition string end shell\">&quot;</span></span> ssh user@supacon.sugoi.ac.jp</span></span>"
              },
              "id": "hOWGdFCpSaqChAl4nK8Wag",
              "content": { "type": "html", "content": "" }
            }
          ]
        },
        "id": "Q-_VUQ56TdiMIyz9VKLvdQ"
      },
      {
        "type": "html",
        "tag": "section",
        "attrs": {},
        "content": {
          "type": "partial",
          "children": [
            {
              "type": "keep",
              "custom": {
                "type": "heading",
                "tag": "h2",
                "slug": "controlmaster"
              },
              "id": "KtNPHToNRUedvcIe47lVCA",
              "content": { "type": "html", "content": "ControlMaster" }
            },
            {
              "type": "html",
              "tag": "p",
              "attrs": {},
              "content": {
                "type": "html",
                "content": "でも<wbr>expectに<wbr>よる<wbr>自動化では<wbr>vscodeの<wbr>remote sshは<wbr>どうにもならず<wbr>困っていた<wbr>ところ、<wbr>Slackで<wbr>指導教員から<code>ControlMaster</code>を<wbr>教えてもらった。"
              },
              "id": "W4asqVD2SEu9Im6xT2R_Dw"
            },
            {
              "type": "keep",
              "custom": {
                "type": "codeblock",
                "lines": 5,
                "title": "text",
                "content": "<span class=\"text plain\">Host supacon.sugoi.ac.jp    User user    ControlMaster auto    ControlPath ~/.ssh/mux-%r@%h:%p.sshsock    ControlPersist 3h</span>"
              },
              "id": "QU045akdTlirsS1DIWQNfQ",
              "content": { "type": "html", "content": "" }
            },
            {
              "type": "html",
              "tag": "p",
              "attrs": {},
              "content": {
                "type": "html",
                "content": "これC<wbr>ontrolMasterが<wbr>あれば<wbr>最初の<wbr>一回だけOTP入れればいいから<wbr>自動化とか<wbr>要らないんじゃないかと<wbr>いう<wbr>気も<wbr>するが、<wbr>最初の<wbr>一回だけでも<wbr>既に<wbr>面倒なので<wbr>一応意味は<wbr>ありそう。<wbr>スクリプトを<wbr>下記のように<wbr>書き換えればControlMasterの<wbr>ソケットが<wbr>ない<wbr>時だけOTPを<wbr>使って<wbr>ログインするように<wbr>出来る。"
              },
              "id": "IPekvno5TSytZz_Be0iE8w"
            },
            {
              "type": "keep",
              "custom": {
                "type": "codeblock",
                "lines": 12,
                "title": "bash",
                "content": "<span class=\"source shell bash\"><span class=\"comment line number-sign shell\"><span class=\"punctuation definition comment begin shell\">#</span></span><span class=\"comment line number-sign shell\">!/bin/shuser=userhost=supacon.sugoi.ac.jpport=22if [ ! -e &quot;$HOME/.ssh/mux-$user@$host:$port.sshsock&quot; ]; then  OTP=&quot;$(op read &quot;op://Personal/supacon/otp?attribute=otp&quot;)&quot;  ssh-with-otp &quot;$OTP&quot; ssh &quot;$user@$host&quot; -p &quot;$port&quot;else  ssh &quot;$user@$host&quot; -p &quot;$port&quot;fi</span></span>"
              },
              "id": "bFBw1AHaTYGfv5W8gEFl0A",
              "content": { "type": "html", "content": "" }
            }
          ]
        },
        "id": "tK-XjYvnTtilWQlovusaKA"
      }
    ]
  }
}
